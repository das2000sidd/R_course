---
title: "Multicentric Analysis"
author: "R course"
date: "4 de Abril de 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE,
                      comment = "", cache = TRUE)
```

# Inicio

Cargamos las librerías

```{r}
library(compareGroups)
library(Hmisc)
library(MASS)
```

Si no las tenéis instaladas podéis instalarlas con

```{r install, eval=FALSE}
install.packages(c("Hmisc", "MASS", "comnpareGroups"))
```


# Importamos datos a R

Leemos los datos


```{r load_data}
multicentric <- read.delim("C:/Juan/CREAL/GitHub/R_course/Data_for_exercises/multicentric.txt")
head(multicentric)
```

# Recodificamos variables y ponemos etiquetas

Cambio la categoría de referencia

```{r}
multicentric$caco <- relevel(multicentric$status, 2)
```

Pongamos primero unas etiquetas a las variables

```{r}
Hmisc::label(multicentric$caco) <- "Caso/control"
Hmisc::label(multicentric$vph) <- "Test papilloma virus"
```

# Análisis descriptivo

Primero indico las variables que quiero analizar. Aquí vamos a usar la opción `method=NA` para indicar que use el test paramétrico o no paramétrico en función de si la variable continua sigue una distribución normal o no

```{r}
descr.multi <- compareGroups(caco ~ edad + niveledu + fumar +
                               edad1sex + nembara + vph, 
                             data = multicentric,
                             method = NA)
```

Ahora creamos la tabla

```{r}
table.multi <- createTable(descr.multi)
table.multi
```

Si queremos ver la tabla en formato HTML o Markdown usamos:

```{r}
export2md(table.multi, width=3, caption="Descriptive statistics")
```



En la siguiente figura podemos ver ....

```{r}
plot(descr.multi['vph'], bivar=TRUE)
```


# Cálculo de ORs

La tabla con las ORs e IC95% se pueden obtener mediante

```{r}
table.or <- createTable(descr.multi, show.ratio = TRUE,
                      show.p.overall = TRUE, show.p.trend = TRUE)
export2md(table.or)
```


Como se observa en la tabla anterior el riesgo de cáncer de cervix para las mujeres con VPH+ respecto a las VPH- es `r table.or$descr[13,3]`

# Supervivencia

Cargamos datos

```{r}
pulmon <- read.delim("C:/Juan/CREAL/GitHub/R_course/Data_for_exercises/pulmon.txt")
head(pulmon)
```

```{r}
pulmon$tsurv <- Surv(pulmon$tiempo, pulmon$estado == 1)
descr.pulmon <- compareGroups(tsurv ~ sexo + edad4 + estclin + ik5 +
                                cirugia + quimio + radioter, pulmon)
table.hr <- createTable(descr.pulmon, show.ratio = TRUE)
export2md(table.hr)
```

Estimo el mejor modelo con un stepwise

```{r}
mod <- coxph(Surv(tiempo, estado) ~ estclin + ik5 +
                                cirugia + quimio + radioter, pulmon)
modStep <- stepAIC(mod, direction = "both")
modStep
```
